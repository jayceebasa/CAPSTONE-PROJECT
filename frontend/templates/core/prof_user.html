{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Responsive Bootstrap4 Shop Template, Created by Imran Hossain from https://imransdesign.com/" />

    <!-- title -->
    <title>ASTIG</title>

    <link rel="stylesheet" href="https://unpkg.com/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <!-- favicon -->
    <link rel="shortcut icon" type="image/png" href="{% static 'assets/img/astig.png' %}" />
    <!-- google font -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet" />
    <!-- fontawesome -->
    <link rel="stylesheet" href="{% static 'assets/css/all.min.css' %}" />
    <!-- bootstrap -->
    <link rel="stylesheet" href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}" />
    <!-- owl carousel -->
    <link rel="stylesheet" href="{% static 'assets/css/owl.carousel.css' %}" />
    <!-- magnific popup -->
    <link rel="stylesheet" href="{% static 'assets/css/magnific-popup.css' %}" />
    <!-- animate css -->
    <link rel="stylesheet" href="{% static 'assets/css/animate.css' %}" />
    <!-- mean menu css -->
    <link rel="stylesheet" href="{% static 'assets/css/meanmenu.min.css' %}" />
    <!-- main style -->
    <link rel="stylesheet" href="{% static 'assets/css/main.css' %}" />
    <!-- responsive -->
    <link rel="stylesheet" href="{% static 'assets/css/responsive.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/user.css' %}" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  </head>

  <body>
    <!-- header -->
    <div class="top-header-area" style="background-color: #051922; margin-top: -20px; margin-top: -20px; padding-bottom: 15px !important">
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-sm-12 text-center">
            <div class="main-menu-wrap">
              <!-- logo -->
              <div class="site-logo">
                <a href="{% url 'core:home' %}">
                  <img src="{% static 'assets/img/astig.png' %}" alt="" style="max-width: 60%" />
                </a>
              </div>
              <!-- logo -->

              <!-- menu start -->
              <nav class="main-menu">
                <ul style="margin-top: 15px">
                  <li class="">
                    <a href="{% url 'core:home' %}">Home</a>
                  </li>

                  <li><a href="{% url 'core:shop' %}">Shop</a></li>
                  <li>
                    <div class="header-icons">
                      <a class="shopping-cart" href="{% url 'core:cart_detail' %}">
                        <i class="fas fa-shopping-cart"></i>
                        {% if cart_item_count > 0 %}
                        <span class="cart-count">{{ cart_item_count }}</span>
                        {% endif %}
                      </a>

                      <!-- Add some CSS to style the cart count -->
                      <style>
                        .shopping-cart {
                          position: relative;
                        }
                        .cart-count {
                          position: absolute;
                          top: 5px;
                          right: -3px;
                          background: rgb(255, 104, 104);
                          color: white;
                          border-radius: 50%;
                          padding: 2px 6px;
                          font-size: 8px;
                        }
                      </style>
                      <a class="mobile-hide user-icon" href="{% url 'core:users' %}"><i class="fas fa-user"></i></a>

                      <a class="logout-button" href="{% url 'core:logout' %}">Logout</a>
                    </div>
                  </li>
                </ul>
              </nav>

              <div class="mobile-menu"></div>
              <!-- menu end -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end header -->
    <!-- Profile 1 - Bootstrap Brain Component -->
    <section class="py-3 py-md-5 py-xl-8">
      <div class="container" style="padding-top: 100px">
        {% if alert %}
        <div class="row justify-content-center">
          <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 col-xxl-4">
            <div class="alert alert-danger alert-dismissible fade show" role="alert" id="alertBox">
              {{ alert }}

              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          </div>
        </div>
        {% endif %} {% if success %}
        <div class="row justify-content-center">
          <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 col-xxl-4">
            <div class="alert alert-success alert-dismissible fade show" role="alert" id="successBox">
              {{ success }}

              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          </div>
        </div>
        {% endif %}
        <div class="row justify-content-md-center">
          <div class="col-12 col-md-10 col-lg-8 col-xl-7 col-xxl-6">
            <h2 class="mb-4 display-5 text-center">{{ user.role|capfirst }} Profile</h2>
            <hr class="w-50 mx-auto mb-5 mb-xl-9 border-dark-subtle" />
          </div>
        </div>
      </div>
      <div class="container">
        <div class="row gy-4 gy-lg-0">
          <div class="col-12 col-lg-4 col-xl-3">
            <div class="row gy-4">
              <div class="col-12">
                <div class="card widget-card border-light shadow-sm">
                  <div class="card-header text-bg-primary" style="background-color: #051922 !important">Welcome, {{user.first_name}}</div>
                  <div class="card-body">
                    <div class="text-center mb-3">
                      <div class="rounded-circle overflow-hidden" style="width: 200px; height: 200px; margin: 0 auto">
                        <img src="{{user.picture.url}}" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover" />
                      </div>
                      <button class="btn btn-primary mt-3" type="button" id="editImageButton">Edit Image</button>
                      <input type="file" id="imageInput" style="display: none" />
                    </div>
                    <h5 class="text-center mb-1">{{user.first_name}} {{user.last_name }}</h5>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-8 col-xl-9">
            <div class="" style="background-color: #05192200">
              <div class="card-body p-4">
                <ul class="nav nav-tabs" id="profileTab" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link active"
                      id="overview-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#overview-tab-pane"
                      type="button"
                      role="tab"
                      aria-controls="overview-tab-pane"
                      aria-selected="true">
                      Overview
                    </button>
                  </li>

                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="profile-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#profile-tab-pane"
                      type="button"
                      role="tab"
                      aria-controls="profile-tab-pane"
                      aria-selected="false">
                      Profile
                    </button>
                  </li>

                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="address-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#address-tab-pane"
                      type="button"
                      role="tab"
                      aria-controls="address-tab-pane"
                      aria-selected="false">
                      Addresses
                    </button>
                  </li>

                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="password-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#password-tab-pane"
                      type="button"
                      role="tab"
                      aria-controls="password-tab-pane"
                      aria-selected="false">
                      Password
                    </button>
                  </li>

                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="transaction-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#transaction-tab-pane"
                      type="button"
                      role="tab"
                      aria-controls="transaction-tab-pane"
                      aria-selected="false">
                      Transaction History
                    </button>
                  </li>
                </ul>

                <script>
                  document.addEventListener("DOMContentLoaded", function () {
                    const tabs = document.querySelectorAll('#profileTab button[data-bs-toggle="tab"]');
                    tabs.forEach((tab) => {
                      tab.addEventListener("shown.bs.tab", function (event) {
                        history.pushState(null, "", "/users/");
                      });
                    });
                  });
                </script>

                <div class="tab-content pt-4" id="profileTabContent" style="height: 286px !important">
                  <div class="tab-pane fade show active" id="overview-tab-pane" role="tabpanel" aria-labelledby="overview-tab" tabindex="0">
                    <h5 class="mb-3">Profile</h5>
                    <div class="row g-0">
                      <div class="col-5 col-md-3 bg-light border-bottom border-white border-3">
                        <div class="p-2">First Name</div>
                      </div>
                      <div class="col-7 col-md-9 bg-light border-start border-bottom border-white border-3">
                        <div class="p-2">{{user.first_name}}</div>
                      </div>
                      <div class="col-5 col-md-3 bg-light border-bottom border-white border-3">
                        <div class="p-2">Last Name</div>
                      </div>
                      <div class="col-7 col-md-9 bg-light border-start border-bottom border-white border-3">
                        <div class="p-2">{{user.last_name}}</div>
                      </div>

                      <div class="col-5 col-md-3 bg-light border-bottom border-white border-3">
                        <div class="p-2">Address</div>
                      </div>
                      <div class="col-7 col-md-9 bg-light border-start border-bottom border-white border-3">
                        <div class="p-2">{{user.address}}</div>
                      </div>
                      <div class="col-5 col-md-3 bg-light border-bottom border-white border-3">
                        <div class="p-2">Phone</div>
                      </div>
                      <div class="col-7 col-md-9 bg-light border-start border-bottom border-white border-3">
                        <div class="p-2">{{user.PhoneNumber}}</div>
                      </div>
                      <div class="col-5 col-md-3 bg-light border-bottom border-white border-3">
                        <div class="p-2">Email</div>
                      </div>
                      <div class="col-7 col-md-9 bg-light border-start border-bottom border-white border-3">
                        <div class="p-2">{{user.email}}</div>
                      </div>
                    </div>
                  </div>

                  <!-- Address Tab -->
                  <div class="tab-pane fade" id="address-tab-pane" role="tabpanel" aria-labelledby="address-tab" tabindex="0">
                    <div id="addressCardsContainer" class="mb-3">
                      <!-- Address cards will be appended here -->
                    </div>
                    <button type="button" class="btn btn-success" id="addAddressButton" data-bs-toggle="modal" data-bs-target="#editAddressModal">
                      Add Address
                    </button>
                    <button type="button" class="btn btn-primary" id="saveSelectedAddressButton">Save Address</button>
                  </div>

                  <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
                    <form action="{% url 'core:update_profile' %}" method="post" class="row gy-3 gy-xxl-4">
                      {% csrf_token %}
                      <div class="col-12 col-md-4">
                        <label for="inputFirstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="inputFirstName" name="first_name" value="{{ user.first_name }}" />
                      </div>
                      <div class="col-12 col-md-4">
                        <label for="inputLastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="inputLastName" name="last_name" value="{{ user.last_name }}" />
                      </div>
                      <div class="col-12 col-md-4">
                        <label for="inputPhone" class="form-label">Phone</label>
                        <input
                          type="tel"
                          class="form-control"
                          id="inputPhone"
                          name="PhoneNumber"
                          placeholder="Phone number"
                          value="{{ user.PhoneNumber|default_if_none:'' }}"
                          pattern="[0-9]{11}"
                          title="Please enter exactly 11 digits" />
                      </div>
                      <div class="col-12 col-md-4">
                        <label for="inputEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="inputEmail" name="email" value="{{ user.email }}" readonly />
                      </div>

                      <input type="hidden" id="hiddenAddress" name="address" value="{{ user.address }}" />
                      <div class="col-12">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                      </div>
                      <input type="hidden" name="user_role" value="{{ user.role }}" />
                    </form>
                  </div>

                  <!-- Edit Address Modal -->
                  <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <form id="addressForm">
                            <div class="mb-3">
                              <label for="regionSelect" class="form-label">Region</label>
                              <select class="form-select" id="regionSelect" required></select>
                            </div>
                            <div class="mb-3">
                              <label for="provinceSelect" class="form-label">Province</label>
                              <select class="form-select" id="provinceSelect" required></select>
                            </div>
                            <div class="mb-3">
                              <label for="citySelect" class="form-label">City/Municipality</label>
                              <select class="form-select" id="citySelect" required></select>
                            </div>
                            <div class="mb-3">
                              <label for="barangaySelect" class="form-label">Barangay</label>
                              <select class="form-select" id="barangaySelect" required></select>
                            </div>
                            <div class="mb-3">
                              <label for="exactAddress" class="form-label">Exact Address</label>
                              <input type="text" class="form-control" id="exactAddress" required />
                            </div>
                          </form>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          <button type="button" class="btn btn-primary" id="saveAddressButton">Save Address</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <script>
                    const PSGC_API_BASE_URL = "https://psgc.gitlab.io/api";
                    let addresses = [];
                    let selectedAddress = "";

                    const regionToIslandGroup = {
                      "Ilocos Region": "Luzon",
                      "Cagayan Valley": "Luzon",
                      "Central Luzon": "Luzon",
                      CALABARZON: "Luzon",
                      MIMAROPA: "Luzon",
                      "Bicol Region": "Luzon",
                      "Cordillera Administrative Region": "Luzon",
                      "National Capital Region": "Luzon",
                      "Western Visayas": "Visayas",
                      "Central Visayas": "Visayas",
                      "Eastern Visayas": "Visayas",
                      "Zamboanga Peninsula": "Mindanao",
                      "Northern Mindanao": "Mindanao",
                      "Davao Region": "Mindanao",
                      SOCCSKSARGEN: "Mindanao",
                      Caraga: "Mindanao",
                      "Bangsamoro Autonomous Region in Muslim Mindanao": "Mindanao",
                    };

                    document.addEventListener("DOMContentLoaded", async function () {
                      await fetchAddresses();
                      displayAddressCards();
                    });

                    document.getElementById("addAddressButton").addEventListener("click", function () {
                      // Clear the form fields
                      document.getElementById("regionSelect").innerHTML = '<option value="">Select Region</option>';
                      document.getElementById("provinceSelect").innerHTML = '<option value="">Select Province</option>';
                      document.getElementById("citySelect").innerHTML = '<option value="">Select City/Municipality</option>';
                      document.getElementById("barangaySelect").innerHTML = '<option value="">Select Barangay</option>';
                      document.getElementById("exactAddress").value = "";

                      // Populate the regions dropdown
                      populateRegions();
                    });

                    document.getElementById("regionSelect").addEventListener("change", async function () {
                      const regionCode = this.value;
                      await populateProvinces(regionCode);
                    });

                    document.getElementById("provinceSelect").addEventListener("change", async function () {
                      const provinceCode = this.value;
                      await populateCitiesOrMunicipalities(provinceCode, "province");
                    });

                    document.getElementById("citySelect").addEventListener("change", async function () {
                      const cityMunicipalityCode = this.value;
                      await populateBarangays(cityMunicipalityCode);
                    });

                    document.getElementById("saveAddressButton").addEventListener("click", async function () {
                      const region = document.getElementById("regionSelect").selectedOptions[0].text;
                      const province = document.getElementById("provinceSelect").selectedOptions[0].text;
                      const city = document.getElementById("citySelect").selectedOptions[0].text;
                      const barangay = document.getElementById("barangaySelect").selectedOptions[0].text;
                      const exactAddress = document.getElementById("exactAddress").value;
                      const fullAddress = `${exactAddress}, ${barangay}, ${city}, ${province}, ${region}`;
                      const islandGroup = getIslandGroup(region);

                      try {
                        const response = await fetch("/save-address/", {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken"),
                          },
                          body: JSON.stringify({ address: fullAddress, islandGroup: islandGroup }),
                        });

                        const result = await response.json();
                        if (result.success) {
                          await fetchAddresses();
                          displayAddressCards();
                          const modal = bootstrap.Modal.getInstance(document.getElementById("editAddressModal"));
                          modal.hide();
                        } else {
                          console.error("Error saving address:", result.error);
                        }
                      } catch (error) {
                        console.error("Error saving address:", error);
                      }
                    });

                    document.getElementById("saveSelectedAddressButton").addEventListener("click", async function () {
                      const selectedAddress = document.querySelector('input[name="defaultAddress"]:checked').value;
                      await saveSelectedAddress(selectedAddress);
                    });

                    async function fetchAddresses() {
                      try {
                        const response = await fetch("/get-addresses/");
                        const result = await response.json();
                        if (result.success) {
                          addresses = result.addresses;
                          selectedAddress = result.selectedAddress;
                        } else {
                          console.error("Error fetching addresses:", result.error);
                        }
                      } catch (error) {
                        console.error("Error fetching addresses:", error);
                      }
                    }

                    function displayAddressCards() {
                      const container = document.getElementById("addressCardsContainer");
                      container.innerHTML = "";
                      addresses.forEach((address, index) => {
                        const addressCard = document.createElement("div");
                        addressCard.className = "card mb-3";
                        addressCard.innerHTML = `
                          <div class="card-body">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="defaultAddress" id="address${index}" value="${address}" ${
                          address === selectedAddress ? "checked" : ""
                        }>
                              <label class="form-check-label" for="address${index}">
                                ${address}
                              </label>
                              <button type="button" class="btn btn-danger btn-sm float-end delete-address-button" data-address="${address}">Delete</button>
                            </div>
                          </div>
                        `;
                        addressCard.querySelector('input[type="radio"]').addEventListener("change", function () {
                          selectedAddress = address;
                        });
                        container.appendChild(addressCard);
                      });

                      // Add event listeners to delete buttons
                      document.querySelectorAll(".delete-address-button").forEach((button) => {
                        button.addEventListener("click", async function () {
                          const addressToDelete = this.getAttribute("data-address");
                          await deleteAddress(addressToDelete);
                        });
                      });
                    }

                    async function deleteAddress(address) {
                      try {
                        const response = await fetch("/delete-address/", {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken"),
                          },
                          body: JSON.stringify({ address: address }),
                        });

                        const result = await response.json();
                        if (result.success) {
                          await fetchAddresses();
                          displayAddressCards();
                        } else {
                          console.error("Error deleting address:", result.error);
                        }
                      } catch (error) {
                        console.error("Error deleting address:", error);
                      }
                    }

                    async function saveSelectedAddress(address) {
                      try {
                        const response = await fetch("/save-selected-address/", {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": getCookie("csrftoken"),
                          },
                          body: new URLSearchParams({ address: address }),
                        });

                        const result = await response.json();
                        if (result.success) {
                          window.location.reload(); // Refresh the page after saving the address
                        } else {
                          console.error("Error saving selected address:", result.error);
                        }
                      } catch (error) {
                        console.error("Error saving selected address:", error);
                      }
                    }

                    function getCookie(name) {
                      let cookieValue = null;
                      if (document.cookie && document.cookie !== "") {
                        const cookies = document.cookie.split("; ");
                        for (let i = 0; i < cookies.length; i++) {
                          const cookie = cookies[i].trim();
                          if (cookie.substring(0, name.length + 1) === name + "=") {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                          }
                        }
                      }
                      return cookieValue;
                    }

                    async function populateRegions(selectedRegion = "") {
                      try {
                        const response = await fetch(`${PSGC_API_BASE_URL}/regions/`);
                        const regions = await response.json();
                        const regionSelect = document.getElementById("regionSelect");
                        regionSelect.innerHTML = '<option value="">Select Region</option>';
                        regions.forEach((region) => {
                          const option = document.createElement("option");
                          option.value = region.code;
                          option.textContent = region.name;
                          if (region.name === selectedRegion) {
                            option.selected = true;
                          }
                          regionSelect.appendChild(option);
                        });
                        if (selectedRegion) {
                          const selectedOption = Array.from(regionSelect.options).find((option) => option.text === selectedRegion);
                          if (selectedOption) {
                            regionSelect.value = selectedOption.value;
                            await populateProvinces(selectedOption.value);
                          }
                        }
                      } catch (error) {
                        console.error("Error fetching regions:", error);
                      }
                    }

                    function getIslandGroup(regionName) {
                      return regionToIslandGroup[regionName] || "Unknown";
                    }

                    async function populateProvinces(regionCode, selectedProvince = "") {
                      try {
                        const provinceSelect = document.getElementById("provinceSelect");
                        if (regionCode === "130000000") {
                          // NCR
                          provinceSelect.innerHTML = '<option value="000000000">No Province</option>';
                          provinceSelect.disabled = true;
                          await populateCitiesOrMunicipalities(regionCode, "region");
                          return;
                        }
                        provinceSelect.disabled = false;
                        const response = await fetch(`${PSGC_API_BASE_URL}/regions/${regionCode}/provinces/`);
                        const provinces = await response.json();
                        provinceSelect.innerHTML = '<option value="">Select Province</option>';
                        provinces.forEach((province) => {
                          const option = document.createElement("option");
                          option.value = province.code;
                          option.textContent = province.name;
                          if (province.name === selectedProvince) {
                            option.selected = true;
                          }
                          provinceSelect.appendChild(option);
                        });
                        if (selectedProvince) {
                          const selectedOption = Array.from(provinceSelect.options).find((option) => option.text === selectedProvince);
                          if (selectedOption) {
                            provinceSelect.value = selectedOption.value;
                            await populateCitiesOrMunicipalities(selectedOption.value, "province");
                          }
                        }
                      } catch (error) {
                        console.error("Error fetching provinces:", error);
                      }
                    }

                    async function populateCitiesOrMunicipalities(code, type, selectedCity = "") {
                      try {
                        const endpoint =
                          type === "region"
                            ? `${PSGC_API_BASE_URL}/regions/${code}/cities-municipalities/`
                            : `${PSGC_API_BASE_URL}/provinces/${code}/cities-municipalities/`;
                        const response = await fetch(endpoint);
                        const cities = await response.json();
                        const citySelect = document.getElementById("citySelect");
                        citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
                        cities.forEach((city) => {
                          const option = document.createElement("option");
                          option.value = city.code;
                          option.textContent = city.name;
                          if (city.name === selectedCity) {
                            option.selected = true;
                          }
                          citySelect.appendChild(option);
                        });
                        if (selectedCity) {
                          const selectedOption = Array.from(citySelect.options).find((option) => option.text === selectedCity);
                          if (selectedOption) {
                            citySelect.value = selectedOption.value;
                            await populateBarangays(selectedOption.value);
                          }
                        }
                      } catch (error) {
                        console.error("Error fetching cities or municipalities:", error);
                      }
                    }

                    async function populateBarangays(cityMunicipalityCode, selectedBarangay = "") {
                      try {
                        const response = await fetch(`${PSGC_API_BASE_URL}/cities-municipalities/${cityMunicipalityCode}/barangays/`);
                        const barangays = await response.json();
                        const barangaySelect = document.getElementById("barangaySelect");
                        barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
                        barangays.forEach((barangay) => {
                          const option = document.createElement("option");
                          option.value = barangay.code;
                          option.textContent = barangay.name;
                          if (barangay.name === selectedBarangay) {
                            option.selected = true;
                          }
                          barangaySelect.appendChild(option);
                        });
                        if (selectedBarangay) {
                          const selectedOption = Array.from(barangaySelect.options).find((option) => option.text === selectedBarangay);
                          if (selectedOption) {
                            barangaySelect.value = selectedOption.value;
                          }
                        }
                      } catch (error) {
                        console.error("Error fetching barangays:", error);
                      }
                    }
                  </script>

                  <div class="tab-pane fade" id="password-tab-pane" role="tabpanel" aria-labelledby="password-tab" tabindex="0">
                    <form action="{% url 'core:change_password' %}" method="post" id="changePasswordForm">
                      {% csrf_token %}
                      <div class="row gy-3 gy-xxl-4">
                        <div class="col-12" style="margin-top: 0px !important">
                          <label for="currentPassword" class="form-label">Current Password</label>
                          <div class="input-group">
                            <input type="password" class="form-control" id="currentPassword" name="current_password" required />
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('currentPassword')">
                              <i class="bi bi-eye"></i>
                            </button>
                          </div>
                        </div>
                        <div class="col-12">
                          <label for="newPassword" class="form-label">New Password</label>
                          <div class="input-group">
                            <input type="password" class="form-control" id="newPassword" name="new_password" required />
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('newPassword')">
                              <i class="bi bi-eye"></i>
                            </button>
                          </div>
                        </div>
                        <div class="col-12">
                          <label for="confirmPassword" class="form-label">Confirm Password</label>
                          <div class="input-group">
                            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required />
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('confirmPassword')">
                              <i class="bi bi-eye"></i>
                            </button>
                          </div>
                        </div>
                        <div class="col-12">
                          <button type="submit" class="btn btn-primary">Change Password</button>
                        </div>

                        <script>
                          function togglePasswordVisibility(id) {
                            const passwordField = document.getElementById(id);
                            const type = passwordField.getAttribute("type") === "password" ? "text" : "password";
                            passwordField.setAttribute("type", type);
                          }
                        </script>

                        <input type="hidden" name="user_role" value="{{ user.role }}" />
                      </div>
                    </form>
                  </div>

                  <!-- Transaction History Tab -->
                  <div class="tab-pane fade" id="transaction-tab-pane" role="tabpanel" aria-labelledby="transaction-tab" tabindex="0">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead>
                          <tr>
                            <th scope="col">Order Number</th>
                            <th scope="col">Date</th>
                            <th scope="col">Total Quantity</th>
                            <th scope="col">Total Amount</th>
                            <th scope="col">Status</th>
                            <th scope="col">Action</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for order in grouped_transactions %}
                          <tr>
                            <td>{{ order.order_number }}</td>
                            <td>{{ order.date }}</td>
                            <td>{{ order.total_quantity }}</td>
                            <td>{{ order.formatted_total_amount_with_shipping }}</td>
                            <td>{{ order.status }}</td>
                            <td>
                              <div class="btn-group" role="group">
                                <button
                                  class="btn btn-sm btn-primary view-order-btn"
                                  data-order="{{ order.order_number }}"
                                  data-bs-toggle="modal"
                                  data-bs-target="#orderDetailsModal">
                                  View Order
                                </button>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    <!-- Pagination Controls -->
                    <nav aria-label="Page navigation" id="paginationContainer">
                      <ul class="pagination justify-content-center">
                        {% if transactions.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ transactions.previous_page_number }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                          <a class="page-link" href="#" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
                        </li>
                        {% endif %} {% for num in transactions.paginator.page_range %}
                        <li class="page-item {% if transactions.number == num %}active{% endif %}">
                          <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                        {% endfor %} {% if transactions.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ transactions.next_page_number }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                          <a class="page-link" href="#" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
                        </li>
                        {% endif %}
                      </ul>
                    </nav>
                  </div>

                  <!-- Order Details Modal -->
                  <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div id="orderDetailsContent">
                            <!-- Order details will be loaded here via JavaScript -->
                          </div>
                          <div id="proofOfPaymentContainer" style="display: none">
                            <h5>Proof of Payment</h5>
                            <img id="proofOfPaymentImage" src="" alt="Proof of Payment" class="img-fluid" />
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          <button type="button" class="btn btn-primary" id="inTransitButton" style="display: none">In Transit</button>
                          <button type="button" class="btn btn-danger" id="cancelOrderButton" style="display: none">Cancel Order</button>
                          <button type="button" class="btn btn-info" id="viewReceiptButton">View Receipt</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Proof of Payment Modal -->
                  <div class="modal fade" id="proofOfPaymentModal" tabindex="-1" aria-labelledby="proofOfPaymentModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="proofOfPaymentModalLabel">Proof of Payment</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <img id="proofOfPaymentImage" src="" alt="Proof of Payment" class="img-fluid" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <script>
                    document.addEventListener("DOMContentLoaded", function () {
                      // Event delegation for view order buttons
                      document.querySelector("#transaction-tab-pane").addEventListener("click", function (event) {
                        if (event.target.classList.contains("view-order-btn")) {
                          const orderNumber = event.target.getAttribute("data-order");
                          // Fetch and display order details using orderNumber
                          fetchOrderDetails(orderNumber);
                        }
                      });

                      // Function to fetch and display order details
                      function fetchOrderDetails(orderNumber) {
                        fetch(`/get_order_details/${orderNumber}/`)
                          .then((response) => response.json())
                          .then((data) => {
                            const orderDetailsContent = document.getElementById("orderDetailsContent");
                            orderDetailsContent.innerHTML = `
                              <p><strong>Order Number:</strong> ${data.order_number}</p>
                              <p><strong>Date:</strong> ${data.date}</p>
                              <p><strong>Status:</strong> ${data.status}</p>
                              <p><strong>User:</strong> ${data.user.first_name} ${data.user.last_name}</p>
                              <p><strong>Address:</strong> ${data.user.address}</p>
                              <h5>Items:</h5>
                              <ul>
                                ${data.items
                                  .map(
                                    (item) => `
                                  <li>
                                    <img src="${item.product.image_url}" alt="${item.product.name}" style="width: 100px; height: 100px;" />
                                    ${item.product.name} - ${item.product.formatted_price} (Quantity: ${item.quantity})
                                  </li>
                                `
                                  )
                                  .join("")}
                              </ul>
                              <p><strong>Total Quantity:</strong> ${data.total_quantity}</p>
                              <p><strong>Total Amount:</strong> ${data.formatted_total_amount}</p>
                              <p><strong>Shipping Fee:</strong> ${data.shipping_fee}</p>
                              <p><strong>Total Amount with Shipping:</strong> ${data.total_amount_with_shipping}</p>
                              ${
                                data.proof_of_payment
                                  ? `<div id="proofOfPaymentContainer"><h5>Proof of Payment</h5><img id="proofOfPaymentImage" src="${data.proof_of_payment}" alt="Proof of Payment" class="img-fluid" /></div>`
                                  : ""
                              }
                            `;

                            // Conditionally display the In Transit and Cancel Order buttons
                            const cancelOrderButton = document.getElementById("cancelOrderButton");
                            if (data.status === "processing") {
                              cancelOrderButton.style.display = "inline-block";
                            } else {
                              cancelOrderButton.style.display = "none";
                            }

                            // Set up the Cancel Order button
                            cancelOrderButton.onclick = function () {
                              fetch(`/update_order_status/${orderNumber}/`, {
                                method: "POST",
                                headers: {
                                  "Content-Type": "application/json",
                                  "X-CSRFToken": "{{ csrf_token }}",
                                },
                                body: JSON.stringify({ status: "cancelled" }),
                              })
                                .then((response) => response.json())
                                .then((data) => {
                                  if (data.success) {
                                    alert("Order status updated to Cancelled");
                                    location.reload();
                                  } else {
                                    alert("Failed to update order status");
                                  }
                                });
                            };

                            // Set up the View Receipt button
                            const viewReceiptButton = document.getElementById("viewReceiptButton");
                            viewReceiptButton.onclick = function () {
                              fetch(`/get_proof_of_payment/${data.items[0].id}/`)
                                .then((response) => response.json())
                                .then((data) => {
                                  if (data.proof_of_payment_url) {
                                    const proofOfPaymentContainer = document.getElementById("proofOfPaymentContainer");
                                    const proofOfPaymentImage = document.getElementById("proofOfPaymentImage");
                                    proofOfPaymentImage.src = data.proof_of_payment_url;
                                    proofOfPaymentImage.style.display = "block"; // Ensure the image is displayed
                                    proofOfPaymentContainer.style.display = "block";
                                  } else {
                                    alert("No proof of payment available");
                                  }
                                });
                            };

                            // Show the modal
                            const modal = document.getElementById("orderDetailsModal");
                            const bootstrapModal = new bootstrap.Modal(modal);
                            bootstrapModal.show();
                          })
                          .catch((error) => console.error("Error fetching order details:", error));
                      }

                      // Add event listener to close the proof of payment modal when the view order modal is hidden
                      const viewOrderModal = document.getElementById("orderDetailsModal");
                      viewOrderModal.addEventListener("hidden.bs.modal", function () {
                        const proofOfPaymentImage = document.getElementById("proofOfPaymentImage");
                        const proofOfPaymentContainer = document.getElementById("proofOfPaymentContainer");
                        proofOfPaymentImage.src = ""; // Reset the proof of payment image source
                        proofOfPaymentImage.style.display = "none"; // Hide the image element
                        proofOfPaymentContainer.style.display = "none"; // Hide the container

                        // Manually remove the modal backdrop
                        const modalBackdrop = document.querySelector(".modal-backdrop");
                        if (modalBackdrop) {
                          modalBackdrop.parentNode.removeChild(modalBackdrop);
                        }
                        document.body.classList.remove("modal-open");
                        document.body.style.paddingRight = "";
                      });
                    });
                  </script>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const paginationLinks = document.querySelectorAll("#paginationContainer .page-link");

        paginationLinks.forEach((link) => {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            const url = this.getAttribute("href");

            fetch(url, {
              headers: {
                "X-Requested-With": "XMLHttpRequest",
              },
            })
              .then((response) => response.text())
              .then((data) => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, "text/html");
                const newTableBody = doc.querySelector("tbody");
                const newPagination = doc.querySelector("#paginationContainer");

                document.querySelector("tbody").innerHTML = newTableBody.innerHTML;
                document.querySelector("#paginationContainer").innerHTML = newPagination.innerHTML;

                // Re-attach event listeners to new pagination links
                const newPaginationLinks = document.querySelectorAll("#paginationContainer .page-link");
                newPaginationLinks.forEach((newLink) => {
                  newLink.addEventListener("click", function (event) {
                    event.preventDefault();
                    const newUrl = this.getAttribute("href");
                    fetch(newUrl, {
                      headers: {
                        "X-Requested-With": "XMLHttpRequest",
                      },
                    })
                      .then((response) => response.text())
                      .then((newData) => {
                        const newDoc = parser.parseFromString(newData, "text/html");
                        const updatedTableBody = newDoc.querySelector("tbody");
                        const updatedPagination = newDoc.querySelector("#paginationContainer");

                        document.querySelector("tbody").innerHTML = updatedTableBody.innerHTML;
                        document.querySelector("#paginationContainer").innerHTML = updatedPagination.innerHTML;
                      });
                  });
                });
              });
          });
        });
      });
    </script>
    <!-- footer -->
    <div class="footer-area" style="margin-top: 1000px !important; bottom: 0 !important; width: 100% !important; padding: 10px !important; height: 25%">
      <div class="container">
        <div class="row justify-content-center">
          <!-- Add justify-content-center -->

          <div class="col-lg-3 col-md-6">
            <div class="footer-box about-widget">
              <!-- Add text-center -->
              <h2 class="widget-title">About us</h2>
              <p>
                Ut enim ad minim veniam perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa
                quae.
              </p>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="footer-box get-in-touch">
              <!-- Add text-center -->
              <h2 class="widget-title">Get in Touch</h2>
              <ul>
                <li>34/8, East Hukupara, Gifirtok, Sadan.</li>
                <li>support@fruitkha.com</li>
                <li>+00 111 222 3333</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end footer -->

    <!-- copyright -->
    <div class="copyright">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 col-md-12">
            <p>Copyrights &copy; 2024 - ASTIG, All Rights Reserved.</p>
          </div>
          <div class="col-lg-6 text-right col-md-12">
            <div class="social-icons">
              <ul>
                <li>
                  <a href="#" target="_blank"><i class="fab fa-facebook-f"></i></a>
                </li>
                <li>
                  <a href="#" target="_blank"><i class="fab fa-twitter"></i></a>
                </li>
                <li>
                  <a href="#" target="_blank"><i class="fab fa-instagram"></i></a>
                </li>
                <li>
                  <a href="#" target="_blank"><i class="fab fa-linkedin"></i></a>
                </li>
                <li>
                  <a href="#" target="_blank"><i class="fab fa-dribbble"></i></a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end copyright -->

    <!-- jquery -->
    <script src="{% static 'assets/js/jquery-1.11.3.min.js' %}"></script>
    <!-- bootstrap -->
    <script src="{% static 'assets/bootstrap/js/bootstrap.min.js' %}"></script>
    <!-- count down -->
    <script src="{% static 'assets/js/jquery.countdown.js' %}"></script>
    <!-- isotope -->
    <script src="{% static 'assets/js/jquery.isotope-3.0.6.min.js' %}"></script>
    <!-- waypoints -->
    <script src="{% static 'assets/js/waypoints.js' %}"></script>
    <!-- owl carousel -->
    <script src="{% static 'assets/js/owl.carousel.min.js' %}"></script>
    <!-- magnific popup -->
    <script src="{% static 'assets/js/jquery.magnific-popup.min.js' %}"></script>
    <!-- mean menu -->
    <script src="{% static 'assets/js/jquery.meanmenu.min.js' %}"></script>
    <!-- sticker js -->
    <script src="{% static 'assets/js/sticker.js' %}"></script>
    <!-- main js -->
    <script src="{% static 'assets/js/main.js' %}"></script>
    <script src="https://unpkg.com/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Handle Delivered button click to change status
      document.querySelectorAll(".change-status-btn").forEach(function (button) {
        button.addEventListener("click", function () {
          var transactionId = this.getAttribute("data-transaction-id");
          console.log("Button clicked for transaction ID:", transactionId); // Debugging log

          // Fetch the CSRF token from the cookie
          const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
              const cookies = document.cookie.split(";");
              for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
                }
              }
            }
            return cookieValue;
          };

          const csrfToken = getCookie("csrftoken");

          fetch("{% url 'core:change_status_delivered' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({
              transaction_id: transactionId,
              status: "Delivered",
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log("Status changed successfully"); // Debugging log
                localStorage.setItem("activeTab", "#transaction-tab-pane"); // Ensure the active tab is set
                location.reload(); // Reload the page to show the updated status
              } else {
                console.error("Error:", data.error); // Debugging log
                alert("Error: " + data.error);
              }
            })
            .catch((error) => {
              console.error("Error:", error); // Debugging log
              alert("An error occurred. Please try again.");
            });
        });
      });
    </script>
    <script src="{% static 'assets/js/prof_user.js' %}"></script>
  </body>
</html>
